<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Smart Environment Control</title>

    <!-- CSRF token in meta tag -->
  <meta name="csrf-token" content="{{ csrf_token }}">


  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet"/>

  <!-- Bootstrap 4.5.2 -->
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet"/>

  <!-- FontAwesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet"/>

  <!-- jQuery UI CSS (for draggable) -->
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css"/>


  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background-color: #f4f7fc;
    }

    .container {
      max-width: 1200px;
      margin-top: 50px;
    }

    h1 {
      font-size: 2.5rem;
      color: #333;
      font-weight: 700;
    }

    .card {
      border-radius: 15px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }

    .card-body {
      padding: 30px;
    }

    .card-title {
      font-size: 1.8rem;
      color: #555;
      font-weight: 600;
    }

    .control-panel {
      margin-top: 30px;
    }
    .control-panel button {
      width: 100%;
      padding: 15px;
      font-size: 1.2rem;
      border-radius: 10px;
      border: none;
      transition: background-color 0.3s ease;
      margin-bottom: 10px;
    }
    .control-panel button:hover {
      background-color: #007bff;
      color: #fff;
    }

    .footer {
      background-color: #343a40;
      color: white;
      padding: 20px;
      text-align: center;
      font-size: 1rem;
      margin-top: 50px;
    }
    .footer a {
      color: #17a2b8;
      text-decoration: none;
    }

    /* Graph Container */
    .graph-container {
      width: 100%;
      height: 400px;
      position: relative; /* for absolutely-positioned elements */
    }

    /* Horizontal lines */
    .horizontal-line {
      position: absolute;
      left: 0;
      width: 100%;
      height: 2px;
      background-color: #ff6347;
      pointer-events: none; /* so clicks pass through to handle */
    }
    .humidity-line {
      background-color: #ff69b4;
    }

    /* Circular handles */
    .temp-handle, .humidity-handle {
      position: absolute;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      top: 100px; /* default position */
      cursor: move;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    .temp-handle {
      background-color: #ff6347;
      left: -15px; /* half the handle's width outside the container for nice look */
    }
    .humidity-handle {
      background-color: #ff69b4;
      right: -15px;
    }

  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header class="text-center">
      <h1>스마트 홈 컨트롤 프로그램</h1>
      <p class="lead text-muted">Control and monitor the temperature, humidity, and actuators for a comfortable environment.</p>
    </header>

    <!-- Main Content Row -->
    <div class="row">
      <!-- Left Panel: Graph -->
      <div class="col-md-8 mb-4">
        <div class="card">
          <div class="card-body">
            <h4 class="card-title">온도/습도 변화 (1시간)</h4>
            <div class="graph-container">
              <!-- Chart.js Canvas -->
              <canvas id="realTimeGraph"></canvas>

              <!-- Temperature line + handle -->
              <div id="tempLine" class="horizontal-line" style="top:100px;"></div>
              <div id="tempHandle" class="temp-handle"></div>

              <!-- Humidity line + handle -->
              <div id="humidLine" class="horizontal-line humidity-line" style="top:200px;"></div>
              <div id="humidHandle" class="humidity-handle"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Panel: Device Control -->
      <div class="col-md-4 mb-4">
        <div class="card control-panel">
          <div class="card-body">
            <h4 class="card-title">원격 제어</h4>
<!--            <button class="btn btn-success btn-lg">에어컨 ON/OFF</button>-->
<!--            <button class="btn btn-danger btn-lg">거실등 ON/OFF</button>-->
<!--            <button class="btn btn-warning btn-lg">현관문 잠금/해제</button>-->
<!--            <button class="btn btn-info btn-lg">보일러 ON/OFF</button>-->
                <button id="acToggle" class="btn btn-success btn-lg">에어컨 ON/OFF</button>
                <button id="lightToggle" class="btn btn-danger btn-lg">거실등 ON/OFF</button>
                <button id="lockToggle" class="btn btn-warning btn-lg">현관문 잠금/해제</button>
                <button id="boilerToggle" class="btn btn-info btn-lg">보일러 ON/OFF</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="footer">
      <p>&copy; 2025 Smart Environment Control System. Built with
        <a href="https://www.djangoproject.com/" target="_blank">Django</a>
        and <a href="https://www.python.org/" target="_blank">Python</a>.
      </p>
    </div>
  </div>

  <!-- JS Libraries -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.3/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    ////////////////////////////////////////////////////////////////////////////
    // 1. Setup Chart.js with two Y-axes (temp / humidity) using numeric x-axis
    ////////////////////////////////////////////////////////////////////////////
    const ctx = document.getElementById('realTimeGraph').getContext('2d');
    let xIndex = 600;  // Start at 600 to simulate the last 5 minutes (600 x 0.5s = 5 minutes)

    // Chart.js initial setup
    const realTimeGraph = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],  // Empty initially, will populate with the last 600 timestamps
            datasets: [
                {
                    label: 'Temperature (°C)',
                    yAxisID: 'tempAxis',
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    data: [],
                    fill: true
                },
                {
                    label: 'Humidity (%)',
                    yAxisID: 'humidAxis',
                    borderColor: 'rgb(54, 162, 235)',
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    data: [],
                    fill: true
                }
            ]
        },
        options: {
            responsive: true,
            animation: false,
            scales: {
                x: {
                    type: 'linear',
                    position: 'bottom',
                    min: 0,
                    max: 60, // Display last 600 data points (5 minutes)
                    title: {
                        display: true,
                        text: 'interval (1 minute steps)'
                    }
                },
                tempAxis: {
                    type: 'linear',
                    position: 'left',
                    min: 0,
                    max: 40,
                    title: {
                        display: true,
                        text: 'Temperature (°C)'
                    }
                },
                humidAxis: {
                    type: 'linear',
                    position: 'right',
                    min: 0,
                    max: 100,
                    title: {
                        display: true,
                        text: 'Humidity (%)'
                    },
                    grid: {
                        drawOnChartArea: false
                    }
                }
            }
        }
    });

// Fetch the initial last 60 data points from the backend
function updateLastGraph() {
    fetch('/get_last_60_sensor_data')
        .then(response => response.json())
        .then(data => {
            // Set the initial data points
            realTimeGraph.data.labels = data.labels;
            realTimeGraph.data.datasets[0].data = data.temperature;
            realTimeGraph.data.datasets[1].data = data.humidity;
            realTimeGraph.update();
        });
}
    ////////////////////////////////////////////////////////////////////////////
    // 2. Simulated real-time data update every 0.5 seconds
    ////////////////////////////////////////////////////////////////////////////
    // Function to update graph with the latest sensor data
function updateGraph() {
    // Fetch the latest sensor data
    fetch('/get_latest_sensor_data')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'failure') {
                console.error('Error fetching sensor data:', data.message);
                return;
            }

            const temperature = data.temperature;
            const humidity = data.humidity;

            // Shift the graph: Remove the oldest data point and add the new one to the left
            if (realTimeGraph.data.labels.length >= 60) {
                realTimeGraph.data.labels.shift(); // Remove the oldest time (label)
                realTimeGraph.data.datasets[0].data.shift(); // Remove the oldest temperature
                realTimeGraph.data.datasets[1].data.shift(); // Remove the oldest humidity
            }

            // Add new data to the left (unshift)
            realTimeGraph.data.labels.unshift(xIndex);  // Add new label (time)
            realTimeGraph.data.datasets[0].data.unshift(temperature);  // Add new temperature value
            realTimeGraph.data.datasets[1].data.unshift(humidity);  // Add new humidity value

            xIndex++; // Increment the time (xIndex)

            // Update the chart
            realTimeGraph.update();
        })
        .catch(error => {
            console.error('Error:', error);
        });
}
    setInterval(updateLastGraph, 3000); // 1 minute update

    ////////////////////////////////////////////////////////////////////////////
    // 3. Draggable Horizontal Lines
    ////////////////////////////////////////////////////////////////////////////
    // We'll constrain the handles so that they can't go outside the .graph-container,
    // and keep the line in sync with the handle's Y-position.

    // Helper to clamp a value between min and max
    function clamp(val, min, max) {
      return Math.max(min, Math.min(max, val));
    }

    const chartHeight = 400;  // The .graph-container is 400px high
const marginTop = 30;     // Set top margin (adjust as needed)
const marginBottom = -130;  // Set bottom margin (adjust as needed)

// --- Temperature line/handle ---
$('#tempHandle').draggable({
  axis: 'y',
  containment: [
    0,                          // Left edge (no left margin needed)
    marginTop,                  // Top margin
    0,                          // Right edge (no right margin needed)
    chartHeight - marginBottom  // Bottom margin
  ], // This confines the handle within the graph area, including margins
  drag: function(event, ui) {
    // Ensure the handle stays within the defined containment area
    const handleHeight = 30;
    ui.position.top = clamp(ui.position.top, marginTop, chartHeight - marginBottom - handleHeight);

    // Move line to the same Y position
    $('#tempLine').css('top', ui.position.top + 'px');

    // Convert pixel to temperature (roughly 0°C @ bottom to 40°C @ top)
    const maxTemp = 40; // Maximum temperature value (Top = 40°C)
    const minTemp = -33.8;  // Minimum temperature value (Bottom = 0°C)

    // Calculate the range of the graph that corresponds to the temperature scale
    const graphRange = chartHeight - marginTop - marginBottom;

    // Invert the scale, so top = 40°C, bottom = 0°C
    const tempValue = maxTemp - ((ui.position.top - marginTop) / graphRange) * (maxTemp - minTemp);
    console.log('Target Temperature: ' + tempValue.toFixed(1) + '°C');

    // Send the updated temperature choice to the server
    updateSensorChoice('temperature_choice', tempValue);
  }
});

// Keep the initial alignment of the temperature line and handle
$('#tempLine').css('top', $('#tempHandle').position().top + 'px');

// --- Humidity line/handle ---
$('#humidHandle').draggable({
  axis: 'y',
  containment: [
    0,                          // Left edge (no left margin needed)
    marginTop,                  // Top margin
    0,                          // Right edge (no right margin needed)
    chartHeight - marginBottom  // Bottom margin
  ], // This confines the handle within the graph area, including margins
  drag: function(event, ui) {
    const handleHeight = 30;
    ui.position.top = clamp(ui.position.top, marginTop, chartHeight - marginBottom - handleHeight);

    $('#humidLine').css('top', ui.position.top + 'px');

    const maxHum = 100; // Maximum humidity value (Top = 100%)
    const minHum = -84.75;   // Minimum humidity value (Bottom = 0%)

    // Calculate the range of the graph that corresponds to the humidity scale
    const graphRange = chartHeight - marginTop - marginBottom;

    // Invert the scale, so top = 100%, bottom = 0%
    const humValue = maxHum - ((ui.position.top - marginTop) / graphRange) * (maxHum - minHum);
    console.log('Target Humidity: ' + humValue.toFixed(1) + '%');

    // Send the updated humidity choice to the server
    updateSensorChoice('humidity_choice', humValue);
  }
});

// Keep the initial alignment of the humidity line and handle
$('#humidLine').css('top', $('#humidHandle').position().top + 'px');


   // 1) Track local states:
    //    (You can initialize them based on real db values if you like.)
    let acOn = false;
    let lightOn = false;
    let locked = true;      // assume door is locked initially
    let boilerOn = false;




    // 3) Each toggle button triggers a fetch POST to /update_actuator with JSON data
    // For toggling the AC (fan)
function toggleAC() {
  acOn = !acOn;  // Flip the local state
  fetch('/update_actuator', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      fan: acOn ? 1 : 0
    })
  })
  .then(response => response.json())
  .then(data => {
    if(data.status !== 'success') {
      console.error('Error:', data.message);
    }
    // Do NOT change button text here; keep it static in HTML
  });
}


// Helper function to send the updated sensor choice to the server via AJAX
function updateSensorChoice(field, value) {
  fetch('/update_sensor_choice', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
    },
    body: JSON.stringify({
      [field]: value
    })
  })
  .then(response => response.json())
  .then(data => {
    if(data.status !== 'success') {
      console.error('Error:', data.message);
    }
  });
}

function toggleLight() {
  lightOn = !lightOn;
  fetch('/update_actuator', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      main_led: lightOn ? 1 : 0
    })
  })
  .then(response => response.json())
  .then(data => {
    if(data.status !== 'success') {
      console.error('Error:', data.message);
    }
  });
}

function toggleLock() {
  locked = !locked;
  fetch('/update_actuator', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      servo_motor: locked ? 0 : 1
    })
  })
  .then(response => response.json())
  .then(data => {
    if(data.status !== 'success') {
      console.error('Error:', data.message);
    }
  });
}

function toggleBoiler() {
  boilerOn = !boilerOn;
  fetch('/update_actuator', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      heater_led: boilerOn ? 1 : 0
    })
  })
  .then(response => response.json())
  .then(data => {
    if(data.status !== 'success') {
      console.error('Error:', data.message);
    }
  });
}

// Attach event listeners
document.getElementById('acToggle').addEventListener('click', toggleAC);
document.getElementById('lightToggle').addEventListener('click', toggleLight);
document.getElementById('lockToggle').addEventListener('click', toggleLock);
document.getElementById('boilerToggle').addEventListener('click', toggleBoiler);


  </script>
</body>
</html>
