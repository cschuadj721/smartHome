<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Smart Environment Control</title>

    <!-- CSRF token in meta tag -->
  <meta name="csrf-token" content="{{ csrf_token }}">


  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet"/>

  <!-- Bootstrap 4.5.2 -->
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet"/>

  <!-- FontAwesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet"/>

  <!-- jQuery UI CSS (for draggable) -->
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css"/>


  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background-color: #f4f7fc;
    }

    .container {
      max-width: 1200px;
      margin-top: 50px;
    }

    h1 {
      font-size: 2.5rem;
      color: #333;
      font-weight: 700;
    }

    .card {
      border-radius: 15px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }

    .card-body {
      padding: 30px;
    }

    .card-title {
      font-size: 1.8rem;
      color: #555;
      font-weight: 600;
    }

    .control-panel {
      margin-top: 30px;
    }
    .control-panel button {
      width: 100%;
      padding: 15px;
      font-size: 1.2rem;
      border-radius: 10px;
      border: none;
      transition: background-color 0.3s ease;
      margin-bottom: 10px;
    }
    .control-panel button:hover {
      background-color: #007bff;
      color: #fff;
    }

    .footer {
      background-color: #343a40;
      color: white;
      padding: 20px;
      text-align: center;
      font-size: 1rem;
      margin-top: 50px;
    }
    .footer a {
      color: #17a2b8;
      text-decoration: none;
    }

    /* Graph Container */
    .graph-container {
      width: 100%;
      height: 400px;
      position: relative; /* for absolutely-positioned elements */
    }

    /* Horizontal lines */
    .horizontal-line {
      position: absolute;
      left: 0;
      width: 100%;
      height: 2px;
      background-color: #ff6347;
      pointer-events: none; /* so clicks pass through to handle */
    }
    .humidity-line {
      background-color: #ff69b4;
    }

    /* Circular handles */
    .temp-handle, .humidity-handle {
      position: absolute;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      top: 100px; /* default position */
      cursor: move;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    .temp-handle {
      background-color: #ff6347;
      left: -15px; /* half the handle's width outside the container for nice look */
    }
    .humidity-handle {
      background-color: #ff69b4;
      right: -15px;
    }

  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header class="text-center">
      <h1>스마트 홈 컨트롤 프로그램</h1>
      <p class="lead text-muted">Control and monitor the temperature, humidity, and actuators for a comfortable environment.</p>
    </header>

    <!-- Main Content Row -->
    <div class="row">
      <!-- Left Panel: Graph -->
      <div class="col-md-8 mb-4">
        <div class="card">
          <div class="card-body">
            <h4 class="card-title">온도/습도 변화 (Last 5 minutes)</h4>
            <div class="graph-container">
              <!-- Chart.js Canvas -->
              <canvas id="realTimeGraph"></canvas>

              <!-- Temperature line + handle -->
              <div id="tempLine" class="horizontal-line" style="top:100px;"></div>
              <div id="tempHandle" class="temp-handle"></div>

              <!-- Humidity line + handle -->
              <div id="humidLine" class="horizontal-line humidity-line" style="top:200px;"></div>
              <div id="humidHandle" class="humidity-handle"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Panel: Device Control -->
      <div class="col-md-4 mb-4">
        <div class="card control-panel">
          <div class="card-body">
            <h4 class="card-title">원격 제어</h4>
<!--            <button class="btn btn-success btn-lg">에어컨 ON/OFF</button>-->
<!--            <button class="btn btn-danger btn-lg">거실등 ON/OFF</button>-->
<!--            <button class="btn btn-warning btn-lg">현관문 잠금/해제</button>-->
<!--            <button class="btn btn-info btn-lg">보일러 ON/OFF</button>-->
                <button id="acToggle" class="btn btn-success btn-lg">에어컨 ON/OFF</button>
                <button id="lightToggle" class="btn btn-danger btn-lg">거실등 ON/OFF</button>
                <button id="lockToggle" class="btn btn-warning btn-lg">현관문 잠금/해제</button>
                <button id="boilerToggle" class="btn btn-info btn-lg">보일러 ON/OFF</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="footer">
      <p>&copy; 2025 Smart Environment Control System. Built with
        <a href="https://www.djangoproject.com/" target="_blank">Django</a>
        and <a href="https://www.python.org/" target="_blank">Python</a>.
      </p>
    </div>
  </div>

  <!-- JS Libraries -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.3/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    ////////////////////////////////////////////////////////////////////////////
    // 1. Setup Chart.js with two Y-axes (temp / humidity) using numeric x-axis
    ////////////////////////////////////////////////////////////////////////////
    let xIndex = 0; // We'll increment this every data update
    const ctx = document.getElementById('realTimeGraph').getContext('2d');

    const realTimeGraph = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [
          {
            label: 'Temperature (°C)',
            yAxisID: 'tempAxis',
            borderColor: 'rgb(255, 99, 132)',
            backgroundColor: 'rgba(255, 99, 132, 0.2)',
            data: [],
            fill: true
          },
          {
            label: 'Humidity (%)',
            yAxisID: 'humidAxis',
            borderColor: 'rgb(54, 162, 235)',
            backgroundColor: 'rgba(54, 162, 235, 0.2)',
            data: [],
            fill: true
          }
        ]
      },
      options: {
        responsive: true,
        animation: false,
        scales: {
          x: {
            type: 'linear',
            position: 'bottom',
            min: 0,
            max: 600, // 600 x 0.5s = 300s = 5 minutes
            title: {
              display: true,
              text: 'Time (0.5s steps)'
            }
          },
          tempAxis: {
            type: 'linear',
            position: 'left',
            min: 0,
            max: 40,
            title: {
              display: true,
              text: 'Temperature (°C)'
            }
          },
          humidAxis: {
            type: 'linear',
            position: 'right',
            min: 0,
            max: 100,
            title: {
              display: true,
              text: 'Humidity (%)'
            },
            grid: {
              drawOnChartArea: false
            }
          }
        }
      }
    });

    ////////////////////////////////////////////////////////////////////////////
    // 2. Simulated real-time data update every 0.5 seconds
    ////////////////////////////////////////////////////////////////////////////
    function updateGraph() {
      // Random temperature (10 ~ 40), humidity (30 ~ 80)
      const tempValue = Math.random() * 30 + 10;
      const humidValue = Math.random() * 50 + 30;

      // Add data point
      realTimeGraph.data.labels.push(xIndex);
      realTimeGraph.data.datasets[0].data.push(tempValue);
      realTimeGraph.data.datasets[1].data.push(humidValue);

      // Keep only last 600 points (5 minutes at 0.5s each)
      if (realTimeGraph.data.labels.length > 600) {
        realTimeGraph.data.labels.shift();
        realTimeGraph.data.datasets[0].data.shift();
        realTimeGraph.data.datasets[1].data.shift();
      }

      xIndex++;
      realTimeGraph.update();
    }
    setInterval(updateGraph, 500); // 0.5 seconds

    ////////////////////////////////////////////////////////////////////////////
    // 3. Draggable Horizontal Lines
    ////////////////////////////////////////////////////////////////////////////
    // We'll constrain the handles so that they can't go outside the .graph-container,
    // and keep the line in sync with the handle's Y-position.

    // Helper to clamp a value between min and max
    function clamp(val, min, max) {
      return Math.max(min, Math.min(max, val));
    }

    const chartHeight = 400;  // The .graph-container is 400px high

    // --- Temperature line/handle ---
    $('#tempHandle').draggable({
      axis: 'y',
      containment: '.graph-container',
      drag: function(event, ui) {
        // Ensure the handle doesn't leave the container (0 <= y <= 400 - handleHeight).
        const handleHeight = 30;
        ui.position.top = clamp(ui.position.top, 0, chartHeight - handleHeight);

        // Move line to the same Y
        $('#tempLine').css('top', ui.position.top + 'px');

        // Convert pixel to temperature (roughly 0°C @ bottom to 40°C @ top)
        const maxTemp = 40;
        // We invert the scale so top=40, bottom=0
        // lineY=0 => 40°C, lineY=400 => 0°C
        const lineY = ui.position.top;
        const tempValue = maxTemp - (lineY / chartHeight) * maxTemp;
        console.log('Target Temperature: ' + tempValue.toFixed(1) + '°C');
      }
    });

    // Keep them aligned initially
    $('#tempLine').css('top', $('#tempHandle').position().top + 'px');

    // --- Humidity line/handle ---
    $('#humidHandle').draggable({
      axis: 'y',
      containment: '.graph-container',
      drag: function(event, ui) {
        const handleHeight = 30;
        ui.position.top = clamp(ui.position.top, 0, chartHeight - handleHeight);

        $('#humidLine').css('top', ui.position.top + 'px');

        const maxHum = 100;
        const lineY = ui.position.top;
        const humValue = maxHum - (lineY / chartHeight) * maxHum;
        console.log('Target Humidity: ' + humValue.toFixed(1) + '%');
      }
    });

    // Keep them aligned initially
    $('#humidLine').css('top', $('#humidHandle').position().top + 'px');

   // 1) Track local states:
    //    (You can initialize them based on real db values if you like.)
    let acOn = false;
    let lightOn = false;
    let locked = true;      // assume door is locked initially
    let boilerOn = false;




    // 3) Each toggle button triggers a fetch POST to /update_actuator with JSON data
    // For toggling the AC (fan)
function toggleAC() {
  acOn = !acOn;  // Flip the local state
  fetch('/update_actuator', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      fan: acOn ? 1 : 0
    })
  })
  .then(response => response.json())
  .then(data => {
    if(data.status !== 'success') {
      console.error('Error:', data.message);
    }
    // Do NOT change button text here; keep it static in HTML
  });
}

function toggleLight() {
  lightOn = !lightOn;
  fetch('/update_actuator', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      main_led: lightOn ? 1 : 0
    })
  })
  .then(response => response.json())
  .then(data => {
    if(data.status !== 'success') {
      console.error('Error:', data.message);
    }
  });
}

function toggleLock() {
  locked = !locked;
  fetch('/update_actuator', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      servo_motor: locked ? 0 : 1
    })
  })
  .then(response => response.json())
  .then(data => {
    if(data.status !== 'success') {
      console.error('Error:', data.message);
    }
  });
}

function toggleBoiler() {
  boilerOn = !boilerOn;
  fetch('/update_actuator', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      heater_led: boilerOn ? 1 : 0
    })
  })
  .then(response => response.json())
  .then(data => {
    if(data.status !== 'success') {
      console.error('Error:', data.message);
    }
  });
}

// Attach event listeners
document.getElementById('acToggle').addEventListener('click', toggleAC);
document.getElementById('lightToggle').addEventListener('click', toggleLight);
document.getElementById('lockToggle').addEventListener('click', toggleLock);
document.getElementById('boilerToggle').addEventListener('click', toggleBoiler);


  </script>
</body>
</html>
